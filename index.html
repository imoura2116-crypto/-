<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSV一問一答（GitHub API自動検出）</title>
  <style>
    :root{--fg:#1f2937;--muted:#6b7280;--acc:#3b82f6}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;background:linear-gradient(135deg,#f5f7fa,#c3cfe2);color:var(--fg);display:flex;flex-direction:column;align-items:center}
    .wrap{width:100%;max-width:860px;padding:10px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select,button,label{font-size:14px}
    select,button{padding:8px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff}
    button.primary{background:linear-gradient(180deg,#60a5fa,#3b82f6);color:#fff;border-color:#60a5fa}
    .status{font-size:12px;color:var(--muted)}
    .card{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:16px;margin-top:10px}
    .q{font-size:22px;text-align:center;word-break:break-word}
    .a{font-size:20px;color:#fff;background:#2563eb;border-radius:12px;padding:14px;text-align:center;margin-top:10px;display:none}
    .prog{font-size:13px;color:var(--muted);text-align:center;margin-top:6px}
    .hint{font-size:12px;color:var(--muted);text-align:center;margin-top:6px}
    @media (min-width:840px){ .q{font-size:24px}.a{font-size:22px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="controls">
      <label>問題集:</label>
      <select id="csvSelect"></select>
      <label><input type="checkbox" id="shuffle" checked> ランダム順</label>
      <button id="loadBtn" class="primary">読み込む</button>
      <span id="status" class="status"></span>
    </div>

    <div class="card" id="touchArea">
      <div id="progress" class="prog">0 / 0 問</div>
      <div id="q" class="q">CSVを選択して「読み込む」を押してください</div>
      <div id="a" class="a">ここに答え</div>
      <div class="hint">タップで答え表示／左右スワイプで前後へ</div>
    </div>
  </div>

  <script>
    let deck = [], idx = 0, xStart = null, yStart = null;
    const $ = id => document.getElementById(id);

    async function loadList(){
      try{
        const {owner, repo} = detectRepoFromLocation();
        const repoInfo = await fetchJSON(`https://api.github.com/repos/${owner}/${repo}`);
        const branch = repoInfo.default_branch || 'main';
        const items = await fetchJSON(`https://api.github.com/repos/${owner}/${repo}/contents/csv?ref=${branch}`);
        const csvFiles = items.filter(x=>x.type==='file' && /\.csv$/i.test(x.name));
        const sel = $('csvSelect'); sel.innerHTML='';
        for(const f of csvFiles){
          const opt = document.createElement('option');
          opt.value = f.download_url; // 直接ダウンロードURL
          opt.textContent = f.name;   // 表示名
          sel.appendChild(opt);
        }
        if(csvFiles.length){ sel.value = csvFiles[0].download_url; }
        $('status').textContent = csvFiles.length + ' ファイル（GitHub API）';
      }catch(e){ $('status').textContent = 'CSV一覧取得失敗: ' + (e.message||e); }
    }

    function detectRepoFromLocation(){
      const host = location.hostname;
      const path = location.pathname.replace(/^\//,'');
      let owner = host.split('.')[0];
      let repo = path.split('/')[0] || '';
      const params = new URLSearchParams(location.search);
      owner = params.get('owner') || owner;
      repo = params.get('repo') || repo;
      return {owner, repo};
    }

    async function fetchJSON(url){
      const res = await fetch(url, {headers:{'Accept':'application/vnd.github+json'}});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }
        $('status').textContent = files.length+ ' ファイル';
      }catch(e){$('status').textContent = 'CSV一覧取得失敗: '+e.message;}
    }

    function detectDelimiter(text){const sample=text.split(/\r?\n/).slice(0,5).join('\n');const cand=[',','\t',';'];let best=',',score=-1;for(const d of cand){const s=sample.split(/\r?\n/).map(l=>l.split(d).length).reduce((a,b)=>a+b,0);if(s>score){score=s;best=d}}return best;}
    function parseCSV(text){const delim=detectDelimiter(text);const rows=text.split(/\r?\n/).map(l=>l.split(delim));return rows.map(r=>({q:(r[0]||'').trim(),a:(r[1]||'').trim()})).filter(x=>x.q&&x.a);}
    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}

    async function loadCSV(){
      const url = $('csvSelect').value; // download_url を保持
      $('status').textContent = '読み込み中…';
      try{
        const res = await fetch(url + (url.includes('?')?'&':'?') + 'v=' + Date.now());
        if(!res.ok) throw new Error('HTTP '+res.status);
        const text = await res.text();
        deck = parseCSV(text);
        if(!deck.length) throw new Error('有効な行がありません（1列目=問題,2列目=回答）');
        if($('shuffle').checked) shuffle(deck);
        idx = 0; update();
        $('status').textContent = `${deck.length} 問 読み込み完了`;
      }catch(e){ $('status').textContent = 'CSV読込失敗: ' + e.message; }
    }

    function update(){$('q').textContent=deck[idx]?.q||'—';$('a').style.display='none';$('a').textContent=deck[idx]?.a||'';$('progress').textContent=`${idx+1} / ${deck.length} 問`;}
    function next(){if(!deck.length)return;idx=(idx+1)%deck.length;update();}
    function prev(){if(!deck.length)return;idx=(idx-1+deck.length)%deck.length;update();}

    $('touchArea').addEventListener('click',()=>{if(!deck.length)return;const ans=$('a');if(ans.style.display==='none')ans.style.display='block';else next();});
    $('touchArea').addEventListener('touchstart',e=>{const t=e.changedTouches[0];xStart=t.clientX;yStart=t.clientY;},{passive:true});
    $('touchArea').addEventListener('touchend',e=>{if(xStart==null)return;const t=e.changedTouches[0];const dx=t.clientX-xStart;const dy=t.clientY-yStart;xStart=yStart=null;if(Math.abs(dx)>50&&Math.abs(dx)>Math.abs(dy)){if(dx>0)prev();else next();}},{passive:true});

    $('loadBtn').addEventListener('click',loadCSV);
    loadList();
  </script>
</body>
</html>
