<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>暗記帳</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    overflow: hidden;
  }
  .tabs {
    display: flex;
    width: 100%;
    background: #ddd;
  }
  .tab {
    flex: 1;
    text-align: center;
    padding: 10px;
    cursor: pointer;
    background: #ccc;
  }
  .tab.active {
    background: #fff;
    font-weight: bold;
  }
  #question, #answer {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    max-width: 90%;
    margin: 20px 0;
    font-size: 1.2em;
    text-align: center;
  }
  #answer {
    background: #4cafef;
    color: white;
    display: none;
  }
  #progress {
    margin-top: 5px;
    font-size: 0.9em;
    color: #555;
  }
  select {
    margin-top: 10px;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
</style>
</head>
<body>
<div class="tabs" id="folderTabs"></div>
<select id="csvSelect"></select>
<div id="question">問題がここに表示されます</div>
<div id="answer"></div>
<div id="progress"></div>
<script>
let qaList = [];
let currentIndex = 0;
let fileStructure = {};

async function loadList() {
  try {
    const res = await fetch('csv/list.json?_=' + Date.now());
    fileStructure = await res.json();
    const folderTabs = document.getElementById('folderTabs');
    Object.keys(fileStructure).forEach((folder, idx) => {
      const tab = document.createElement('div');
      tab.className = 'tab' + (idx === 0 ? ' active' : '');
      tab.textContent = folder;
      tab.addEventListener('click', () => selectFolder(folder, tab));
      folderTabs.appendChild(tab);
    });
    if (Object.keys(fileStructure).length > 0) {
      selectFolder(Object.keys(fileStructure)[0], folderTabs.children[0]);
    }
  } catch (e) {
    console.error('リスト取得失敗:', e);
  }
}

function selectFolder(folder, tabEl) {
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  tabEl.classList.add('active');
  const select = document.getElementById('csvSelect');
  select.innerHTML = '';
  fileStructure[folder].forEach(file => {
    const opt = document.createElement('option');
    opt.value = file;
    opt.textContent = file.split('/').pop();
    select.appendChild(opt);
  });
  select.onchange = () => loadCSV(select.value);
  if (fileStructure[folder].length > 0) loadCSV(fileStructure[folder][0]);
}

async function loadCSV(path) {
  const res = await fetch(path + '?_=' + Date.now());
  const text = await res.text();
  qaList = text.trim().split(/\r?\n/).map(line => {
    const [q, a] = line.split(',');
    return {q, a};
  });
  currentIndex = 0;
  shuffleQuestions();
  showQuestion();
}

function shuffleQuestions() {
  for (let i = qaList.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [qaList[i], qaList[j]] = [qaList[j], qaList[i]];
  }
}

function showQuestion() {
  document.getElementById('question').textContent = qaList[currentIndex].q;
  document.getElementById('answer').style.display = 'none';
  document.getElementById('progress').textContent = `${currentIndex + 1} / ${qaList.length}問`;
}

document.body.addEventListener('click', () => {
  const ansDiv = document.getElementById('answer');
  if (ansDiv.style.display === 'none') {
    ansDiv.textContent = qaList[currentIndex].a;
    ansDiv.style.display = 'block';
  } else {
    if (currentIndex < qaList.length - 1) {
      currentIndex++;
    } else {
      currentIndex = 0;
    }
    showQuestion();
  }
});

document.body.addEventListener('touchstart', handleTouchStart, false);
document.body.addEventListener('touchend', handleTouchEnd, false);
let xDown = null;
function handleTouchStart(evt) {
  xDown = evt.touches[0].clientX;
}
function handleTouchEnd(evt) {
  if (!xDown) return;
  let xUp = evt.changedTouches[0].clientX;
  let xDiff = xDown - xUp;
  if (Math.abs(xDiff) > 50) {
    if (xDiff > 0 && currentIndex < qaList.length - 1) {
      currentIndex++;
    } else if (xDiff < 0 && currentIndex > 0) {
      currentIndex--;
    }
    showQuestion();
  }
  xDown = null;
}

loadList();
</script>
</body>
</html>
